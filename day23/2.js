const test = `#.#####################
#.......#########...###
#######.#########.#.###
###.....#.>.>.###.#.###
###v#####.#v#.###.#.###
###.>...#.#.#.....#...#
###v###.#.#.#########.#
###...#.#.#.......#...#
#####.#.#.#######.#.###
#.....#.#.#.......#...#
#.#####.#.#.#########v#
#.#...#...#...###...>.#
#.#.#v#######v###.###v#
#...#.>.#...>.>.#.###.#
#####v#.#.###v#.#.###.#
#.....#...#...#.#.#...#
#.#########.###.#.#.###
#...###...#...#...#.###
###.###.#.###v#####v###
#...#...#.#.>.>.#.>.###
#.###.###.#.###.#.#v###
#.....###...###...#...#
#####################.#`;

const raw = `#.###########################################################################################################################################
#.#...###.......###...#...#...#...............#...#.......#...#####.....#.........#...#...#...#.....#...#...#...#...#...#.........#.....#...#
#.#.#.###.#####.###.#.#.#.#.#.#.#############.#.#.#.#####.#.#.#####.###.#.#######.#.#.#.#.#.#.#.###.#.#.#.#.#.#.#.#.#.#.#.#######.#.###.#.#.#
#.#.#.#...#.....#...#...#.#.#.#.....#.........#.#.#.#.....#.#...###.#...#.....#...#.#.#.#.#.#.#.#...#.#.#.#.#.#.#.#.#.#.#...#.....#.#...#.#.#
#.#.#.#.###.#####.#######.#.#.#####.#.#########.#.#.#.#####.###.###.#.#######.#.###.#.#.#.#.#.#.#.###.#.#.#.#.#.#.#.#.#.###.#.#####.#.###.#.#
#...#.#.#...###...#.....#.#.#.>.>...#.#...#...#.#.#.#.....#.#...#...#...#.....#...#.#...#.#.#.#.#...#.#...#.#.#.#.#.#.#.#...#...#...#.#...#.#
#####.#.#.#####.###.###.#.#.###v#####.#.#.#.#.#.#.#.#####.#.#.###.#####.#.#######.#.#####.#.#.#.###.#.#####.#.#.#.#.#.#.#.#####.#.###.#.###.#
#.....#.#.....#.....#...#.#.###...#...#.#.#.#.#.#.#.#.....#.#.###...#...#.....#...#...#...#.#.#...#.#.#.....#.#.#.#.#.#.#.#.....#...#.#.#...#
#.#####.#####.#######.###.#.#####.#.###.#.#.#.#.#.#.#.#####.#.#####.#.#######.#.#####.#.###.#.###.#.#.#.#####.#.#.#.#.#.#.#.#######.#.#.#.###
#.#...#.#.....#.......###...#.....#...#.#.#.#.#.#.#.#.#...#.#.>.>.#.#.#...###.#.###...#...#.#...#.#...#.>.>.#.#.#.#.#.#.#.#.#...#...#...#...#
#.#.#.#.#.#####.#############.#######.#.#.#.#.#.#.#.#.#.#.#.###v#.#.#.#.#.###.#.###.#####.#.###.#.#######v#.#.#.#.#.#.#.#.#.#.#.#.#########.#
#.#.#...#.....#.#...........#.......#.#.#.#.#...#.#.#...#.#.###.#.#.#.#.#.#...#.>.>.#.....#...#.#.#.......#...#.#.#...#.#.#.#.#.#.#.........#
#.#.#########.#.#.#########.#######.#.#.#.#.#####.#.#####.#.###.#.#.#.#.#.#.#####v###.#######.#.#.#.###########.#.#####.#.#.#.#.#.#.#########
#.#.#.........#...#.....#...#.......#.#.#.#...#...#.#.....#.#...#...#.#.#...#...#...#.#.....#.#...#.......#...#.#...#...#.#...#...#.........#
#.#.#.#############.###.#.###.#######.#.#.###.#.###.#.#####.#.#######.#.#####.#.###.#.#.###.#.###########.#.#.#.###.#.###.#################.#
#.#.#...#...#...#...#...#.###...#...#...#...#.#.#...#...#...#.......#.#.#.....#.....#.#...#.#.....#######...#.#.....#...#...#...............#
#.#.###.#.#.#.#.#.###.###.#####.#.#.#######.#.#.#.#####.#.#########.#.#.#.###########.###.#.#####.###########.#########.###.#.###############
#.#.#...#.#.#.#.#...#...#.....#...#.......#.#.#.#.###...#.#.........#...#...........#...#.#...#...#.........#...#.......#...#.........#...###
#.#.#.###.#v#.#.###.###.#####.###########.#.#.#.#.###.###.#.#######################.###.#.###.#.###.#######.###.#.#######.###########.#.#.###
#...#.....#.>.#...#.###.......#...#.......#...#...#...#...#.......#...#...#.......#...#.#...#.#.#...#.....#...#.#.#...#...#.........#...#...#
###########v#####.#.###########.#.#.###############.###.#########.#.#.#.#.#.#####.###.#.###.#.#.#.###.###.###.#.#.#.#.#.###.#######.#######.#
#.........#...#...#.....#...#...#.#.#...###...#...#...#.###...#...#.#.#.#.#.....#.#...#...#.#...#.....###...#...#...#...###.......#.#.......#
#.#######.###.#.#######.#.#.#.###.#.#.#.###.#.#.#.###.#.###.#.#.###.#.#.#.#####.#.#.#####.#.###############.#####################.#.#.#######
#.......#.....#.......#.#.#.#...#.#...#...#.#...#...#...#...#.#...#.#.#.#.......#...#...#...###...#.........#...#...#.......#.....#...#...###
#######.#############.#.#.#.###.#.#######.#.#######.#####.###.###.#.#.#.#############.#.#######.#.#.#########.#.#.#.#.#####.#.#########.#.###
#...###...........###...#.#.....#.........#.#.......#...#...#.#...#.#.#...#...#.......#.#...#...#.#...........#...#.#.....#.#.....#...#.#...#
#.#.#############.#######.#################.#.#######.#.###.#.#.###.#.###.#.#.#.#######.#.#.#.###.#################.#####.#.#####.#.#.#.###.#
#.#.#.......#.....#.......#...#.........#...#.#...#...#.#...#.#.#...#.###...#.#.#.......#.#.#.#...#...###...........#...#.#.#...#...#...#...#
#.#.#.#####.#.#####.#######.#.#.#######.#.###.#.#.#.###.#.###.#.#.###.#######v#.#.#######.#.#.#.###.#.###.###########.#.#.#.#.#.#########.###
#.#.#.#...#...#...#.#...#...#...###...#.#.#...#.#.#...#.#...#.#.#...#.#...#.>.>.#.....#...#.#.#.#...#.....#...#.......#.#.#...#.......#...###
#.#.#.#.#v#####.#.#.#.#.#.#########.#.#.#.#.###.#.###.#.###.#.#v###.#.#.#.#.#v#######.#.###.#.#.#.#########.#.#.#######.#.###########.#.#####
#.#.#...#.>.###.#.#...#...#...#.....#...#.#...#.#.#...#.#...#.>.>...#.#.#...#.#.......#.#...#.#.#...#.......#.#.....#...#.........###...#...#
#.#.#####v#.###.#.#########.#.#.#########.###.#.#.#.###.#.#####v#####.#.#####.#.#######.#.###.#.###.#.#######.#####.#.###########v#######.#.#
#.#.#.....#.....#.......###.#.#.......#...#...#.#.#...#.#.#####.....#.#...#...#...#...#.#.###.#.###...###.....#...#.#...#.....#.>.#.......#.#
#.#.#.#################.###.#.#######.#.###.###.#.###.#.#.#########.#.###.#.#####.#.#.#.#.###.#.#########.#####.#.#.###.#.###.#.#v#.#######.#
#.#.#.....###...........#...#.#...#...#...#.....#...#.#.#.#.........#.#...#.....#.#.#.#.#...#.#.#...#...#.#...#.#...#...#.###...#.#.#.......#
#.#.#####.###.###########.###.#.#.#.#####.#########.#.#.#.#.#########.#.#######.#.#.#.#.###.#.#.#.#.#.#.#v#.#.#.#####.###.#######.#.#.#######
#.#.#.....#...###...#...#...#.#.#.#.#...#.#.......#.#.#...#.........#.#.#...#...#.#.#.#.#...#.#.#.#.#.#.>.>.#.#.....#.....#.....#...#...#...#
#.#.#.#####.#####.#.#.#.###.#.#.#.#.#.#.#.#.#####.#.#.#############.#.#.#.#.#.###.#.#.#.#.###.#.#.#.#.###v###.#####.#######.###.#######.#.#.#
#.#.#.....#...#...#.#.#.###.#.#.#.#.#.#.#...#.....#.#.#.............#...#.#...###.#.#.#.#.#...#...#.#.#...###.#.....#.......#...#.....#...#.#
#.#.#####.###.#.###.#.#.###.#.#.#.#v#.#.#####.#####.#.#.#################.#######.#.#.#.#.#.#######.#.#.#####.#.#####.#######.###.###.#####.#
#.#.#.....###.#.#...#.#...#.#.#.#.>.>.#.#...#.....#...#...............###.......#...#.#.#.#.....###...#.....#.#.....#...#...#.....###...#...#
#.#.#.#######.#.#.###.###.#.#.#.###v###.#.#.#####.###################.#########.#####.#.#.#####.###########.#.#####.###.#.#.###########.#.###
#.#.#.......#...#...#...#.#.#.#.#...###...#.#...#.....#...............#.........#...#.#.#.#...#.#.......#...#.....#.###...#.........#...#.###
#.#.#######.#######.###.#.#.#.#.#.#########.#.#.#####.#.###############.#########.#.#.#.#.#.#.#.#.#####.#.#######.#.###############.#.###.###
#.#.........###.....#...#.#.#...#.......###...#.......#.............###...........#.#...#.#.#.#.#.....#...###...#...#...............#.....###
#.#############.#####.###.#.###########.###########################.###############.#####.#.#.#.#####.#######.#.#####.#######################
#.#.......#...#...#...###.#...#.........#...#...#######.............#.....###.....#.....#.#.#...#...#.......#.#.....#...........#.....#...###
#.#.#####.#.#.###.#.#####.###.#.#########.#.#.#.#######.#############.###.###.###.#####.#.#.#####.#.#######.#.#####.###########.#.###.#.#.###
#.#.#.....#.#.###.#.#...#.....#.#...#.....#...#...###...#.......#...#...#.....###.......#.#...#...#.........#.#.....#...........#.#...#.#...#
#.#.#.#####.#.###.#.#.#.#######.#.#.#.###########.###.###.#####.#.#.###.#################.###.#.#############.#.#####.###########.#.###.###.#
#.#.#.#...#.#...#...#.#.###...#...#...#.....#...#...#.....#...#...#...#...#...........#...#...#...............#.#...#.............#...#...#.#
#.#.#.#.#.#.###.#####.#.###.#.#########.###.#.#.###.#######.#.#######.###.#.#########.#.###.###################.#.#.#################.###.#.#
#...#.#.#.#.#...#...#.#.#...#.###.....#...#...#.....###.....#.#.......#...#.#.........#.....#.....#.............#.#.#...............#.....#.#
#####v#.#.#.#.###.#.#.#.#.###.###.###.###.#############.#####.#.#######.###.#.###############.###.#.#############.#.#.#############.#######.#
#...#.>.#.#.#...#.#.#.#.#...#...#...#.....###...#.....#.....#...#...###.#...#.......#...#...#.#...#.............#.#.#.......###...#...#...#.#
#.#.#v###.#.###.#.#.#.#.###.###.###.#########.#.#.###.#####.#####.#.###.#.#########.#.#.#.#.#.#.###############.#.#.#######.###.#.###.#.#.#.#
#.#.#...#.#...#...#...#...#.#...###.........#.#.#.#...#...#.#...#.#...#...#.........#.#.#.#.#.#.#...#...........#.#.#.....#.....#.#...#.#.#.#
#.#.###.#.###.###########.#.#.#############.#.#.#.#.###.#.#v#.#.#.###.#####.#########.#.#.#.#.#.#.#.#.###########.#.#.###.#######.#.###.#.#.#
#.#.#...#...#.#...........#.#.#...#...#.....#.#.#.#.#...#.>.>.#.#.#...#...#...#...###.#.#.#.#.#.#.#.#.....###...#.#.#.#...#...#...#.....#.#.#
#.#.#.#####.#.#.###########.#.#.#.#.#.#v#####.#.#.#.#.#####v###.#.#.###.#.###v#.#.###.#.#.#.#.#.#.#.#####v###.#.#.#.#.#.###v#.#.#########.#.#
#.#...#...#.#.#...#.......#.#.#.#.#.#.>.>...#.#.#.#...#####...#.#.#...#.#.#.>.>.#...#.#.#.#.#.#.#.#...#.>.>.#.#.#.#...#.#.>.#...###.....#...#
#.#####.#.#.#.###.#.#####.#.#.#.#.#.###v###.#.#.#.###########.#.#.###.#.#.#.#v#####.#.#.#.#.#.#.#.###.#.#v#.#.#.#.#####.#.#v#######.###.#####
#.#.....#.#...#...#.#.....#.#.#.#...###...#.#.#.#.#...#.......#...#...#.#...#.....#.#.#.#.#.#.#.#...#.#.#.#...#.#...###.#.#...#...#...#.....#
#.#.#####.#####.###.#.#####.#.#.#########.#.#.#.#.#.#.#.###########.###.#########.#.#.#.#.#.#.#.###.#.#.#.#####.###.###.#.###.#.#.###.#####.#
#.#.#.....#...#.....#.....#.#.#.......###.#...#.#...#.#...........#...#.#.........#...#.#.#.#.#.#...#.#.#.#...#.....#...#.#...#.#.#...#...#.#
#.#.#.#####.#.###########.#.#.#######.###.#####.#####.###########.###.#.#.#############.#.#.#.#.#.###.#.#.#.#.#######.###.#.###.#.#.###.#.#.#
#...#.......#...........#.#.#...#...#.#...###...#...#.#...........###.#.#.#...###.....#.#.#.#.#.#.#...#.#...#...#...#...#.#.....#...#...#...#
#######################.#.#.###.#.#.#.#.#####.###.#.#.#.#############.#.#.#.#.###.###.#.#.#.#.#.#.#.###.#######.#.#.###.#.###########.#######
#.................#.....#.#.#...#.#...#.....#.#...#...#.#...........#...#...#.....#...#...#...#...#...#.#.......#.#.###...#...........###...#
#.###############.#.#####.#.#.###.#########.#.#.#######.#.#########.###############.#################.#.#.#######.#.#######.#############.#.#
#...............#.#.#...#...#...#.....#.....#.#.....###...#.........#.....#.........#...#...#.....###...#...#.....#.......#.#.............#.#
###############.#.#.#.#.#######.#####.#.#####.#####.#######.#########.###.#.#########.#.#.#.#.###.#########.#.###########.#.#.#############.#
#...............#...#.#.#.....#.#.....#.....#.......#...###.....#...#...#.#.......#...#.#.#.#.#...#...#.....#.#.....#.....#...#...#.........#
#.###################.#.#.###.#.#.#########.#########.#.#######.#.#.###.#.#######.#.###.#.#.#.#.###.#.#.#####.#.###.#.#########v#.#.#########
#.#...........#...#...#...#...#...#.....#...#...#...#.#.#.......#.#...#.#.###.....#.#...#.#...#...#.#.#.....#.#...#...#.......>.#...###...###
#.#.#########.#.#.#.#######.#######.###.#.###.#.#.#.#.#.#.#######.###.#.#.###v#####.#.###.#######.#.#.#####.#.###.#####.#######v#######.#.###
#.#.#.........#.#.#.......#.#...###...#...#...#.#.#.#.#.#.....###.#...#.#.#.>.>.....#...#...#.....#.#.....#...###...###.......#...#.....#...#
#.#.#.#########.#.#######.#.#.#.#####.#####.###.#.#.#.#.#####v###.#.###.#.#.#v#########.###.#.#####.#####.#########.#########.###.#.#######.#
#.#.#.#...#...#.#.#...###.#.#.#.#...#.....#...#.#.#.#.#.#...>.>.#.#.#...#.#.#.#.....#...#...#.....#.#.....###.......#...#.....#...#.#.......#
#.#.#.#.#.#.#.#.#.#.#.###.#.#.#.#.#.#####v###.#.#.#.#.#.#.###v#.#.#.#.###.#.#.#.###.#.###.#######.#.#.#######.#######.#.#.#####.###.#.#######
#...#...#.#.#.#.#.#.#...#.#.#.#.#.#.#...>.>...#...#.#.#...#...#...#.#.#...#.#...#...#.#...#.......#.#...#...#.....#...#.#.....#.....#.......#
#########v#.#.#.#.#.###.#.#.#.#.#.#.#.###v#########.#.#####.#######.#.#.###.#####.###.#.###.#######.###.#.#.#####.#.###.#####.#############.#
###...###.>.#.#.#.#...#.#.#.#.#.#.#.#...#...#...###...#.....#.....#...#...#...#...###.#.###...#...#.#...#.#.#...#.#...#.....#.#.............#
###.#.###v###.#.#.###.#.#.#.#.#.#.#.###.###.#.#.#######.#####.###.#######.###.#.#####.#.#####.#.#.#.#.###.#.#.#.#.###.#####.#.#.#############
#...#.#...###.#.#.#...#...#.#.#.#.#...#.###...#...#...#.......#...#.......#...#.....#.#.#.....#.#...#.#...#...#.#.###.....#...#.............#
#.###.#.#####.#.#.#.#######.#.#.#.###.#.#########.#.#.#########.###.#######.#######.#.#.#.#####.#####.#.#######.#.#######.#################.#
#...#.#.....#...#.#.......#...#.#...#.#.#.........#.#...###.....###...#...#.#####...#...#.#...#...#...#.#.......#.#...###...#...............#
###.#.#####.#####.#######.#####.###.#.#.#.#########.###.###.#########.#.#.#.#####.#######.#.#.###.#.###.#.#######v#.#.#####.#.###############
#...#.......###...#...#...#.....#...#...#.........#...#.....#...#####.#.#.#.#.....#.......#.#...#.#...#.#.#...#.>.>.#...#...#...............#
#.#############.###.#.#.###.#####.###############.###.#######.#.#####.#.#.#.#.#####.#######.###.#.###.#.#.#.#.#.#v#####.#.#################.#
#.............#.....#...###...#...#...........#...###.#.......#.....#...#.#.#.....#.......#.#...#...#...#...#.#.#.....#.#.#.............#...#
#############.###############.#.###.#########.#.#####.#.###########.#####.#.#####.#######.#.#.#####.#########.#.#####.#.#.#.###########.#.###
#.............#...#####.....#.#...#.........#.#.#.....#.#...........#...#...#...#.......#.#.#.#...#.......###...#.....#...#...........#...###
#.#############.#.#####.###.#.###.#########.#.#.#.#####.#.###########.#.#####.#.#######.#.#.#.#.#.#######.#######.###################.#######
#...............#.......#...#...#.#.........#.#.#.......#.............#...#...#.........#...#.#.#.#.......#.......#...###.......#...#.......#
#########################.#####.#.#.#########.#.#########################.#.#################.#.#.#.#######.#######.#.###.#####.#.#.#######.#
#.........................#...#.#.#.........#...#...#.....................#.......#...#...###...#...#.......#.......#...#.#...#...#.#.....#.#
#.#########################.#.#.#.#########.#####.#.#.###########################.#.#.#.#.###########.#######.#########.#.#.#.#####.#.###.#.#
#.............#...#...#...#.#.#...#.......#...###.#.#...................###...###...#.#.#.#.....#.....#.......###.....#.#...#.....#.#...#...#
#############.#.#.#.#.#.#.#.#.#####.#####.###.###.#.###################.###.#.#######.#.#.#.###.#.#####.#########.###.#.#########.#.###.#####
#...#...#.....#.#.#.#...#...#.#...#.....#.....#...#.#.....#.............#...#.......#...#...#...#.......#.....#...###...#.........#.....#...#
#.#.#.#.#v#####.#.#.#########.#.#.#####.#######.###.#.###.#.#############.#########.#########.###########.###.#.#########.###############.#.#
#.#...#.#.>.###.#.#...#.......#.#.#...#.....###...#.#...#.#.#...#.......#.........#.#...#...#...#...#...#.#...#...#...###...............#.#.#
#.#####.#v#.###.#.###.#.#######.#.#.#.#####.#####.#.###.#.#v#.#.#.#####.#########.#.#.#.#.#.###.#.#.#.#.#.#.#####.#.#.#################.#.#.#
#.#...#...#...#.#.#...#.......#.#.#.#.#.....#...#.#.....#.>.>.#.#.#.....#...#.....#...#...#.....#.#.#.#.#.#.#.....#.#.....#.............#.#.#
#.#.#.#######.#.#.#.#########.#.#.#.#.#.#####.#.#.#########v###.#.#.#####.#.#.###################.#.#.#.#.#.#.#####.#####.#.#############.#.#
#.#.#...#...#...#.#.#.........#.#.#.#.#.....#.#...###.....#.#...#.#.#...#.#.#.....#...###...#...#.#.#.#.#.#.#.....#.....#.#.......#...#...#.#
#.#.###.#.#.#####.#.#.#########.#.#.#.#####.#.#######.###.#.#.###.#.#.#.#.#.#####v#.#.###.#.#.#.#.#.#.#.#.#.#####v#####.#.#######.#.#.#.###.#
#.#.###...#.....#.#.#...#...###.#.#.#.#...#.#.....#...###.#.#...#.#.#.#.#.#.....>.>.#.#...#.#.#...#.#.#.#.#.#...>.>.###.#.#.....#...#...#...#
#.#.###########.#.#.###.#.#.###.#.#.#.#.#.#v#####.#.#####.#.###.#.#.#.#.#.#######v###.#.###.#.#####.#.#.#.#.#.###v#.###.#.#.###.#########.###
#...#...#.......#...###.#.#...#.#.#.#.#.#.>.>.#...#.....#...#...#.#.#.#...###...#.#...#.#...#.....#.#.#.#.#...#...#...#.#.#...#...........###
#####.#.#.#############.#.###.#.#.#.#.#.###v#.#.#######.#####.###.#.#.#######.#.#.#.###.#.#######.#.#.#.#.#####.#####.#.#.###v###############
#.....#.#.......#.......#.###.#.#.#.#...###.#.#...#.....###...#...#.#.#.......#...#...#.#...#.....#.#.#.#.#.....#...#...#.#.>.#.......#...###
#.#####.#######.#.#######.###.#.#.#.#######.#.###.#.#######.###.###.#.#.#############.#.###.#.#####.#.#.#.#.#####.#.#####.#.#v#.#####.#.#.###
#.#...#.........#.....#...#...#.#.#.###.....#.#...#.......#...#...#.#.#.....#...#####...###.#.....#.#.#...#.......#.....#...#...#...#...#...#
#.#.#.###############.#.###.###.#.#.###.#####.#.#########.###.###.#.#.#####.#.#.###########.#####.#.#.#################.#########.#.#######.#
#...#...............#.#.###.....#.#.#...#...#...#...#.....###.....#...#...#...#.........#...#...#.#.#.#.......#...#...#.#.........#.........#
###################.#.#.#########.#.#.###.#.#####.#.#.#################.#.#############.#.###.#.#.#.#.#.#####.#.#.#.#.#.#.###################
#...................#.#.#...#...#...#.....#.....#.#...#...#...#...#...#.#.#...#.........#.#...#...#.#.#.....#...#...#...#...#...............#
#.###################.#.#.#.#.#.###############.#.#####.#.#.#.#.#.#.#.#.#.#.#.#.#########.#.#######.#.#####.###############.#.#############.#
#...................#.#.#.#...#...#.............#.......#.#.#.#.#.#.#...#...#.#.....#...#...#...###...#.....#...###.......#...#...#.........#
###################.#.#.#.#######.#.#####################.#.#.#.#.#.#########.#####.#.#.#####.#.#######.#####.#.###.#####.#####.#.#.#########
#...................#...#.....#...#.#...#.........#.....#.#.#...#.#.#.......#.......#.#.....#.#.#.....#.......#...#.....#.......#...#.......#
#.###########################.#.###.#.#.#.#######.#.###.#.#.#####.#.#.#####.#########.#####.#.#.#.###.###########.#####.#############.#####.#
#.....#...........#...###...#.#...#...#...#.......#...#...#.#.....#...#.....#...###...#.....#.#.#...#.#...........#...#.....#.........#.....#
#####.#.#########.#.#.###.#.#.###.#########.#########v#####.#.#########.#####.#.###.###.#####.#.###.#.#.###########.#.#####.#.#########.#####
#...#...###.......#.#.###.#.#...#.#...#.....#.....#.>.>.###.#.#####...#.....#.#.###.#...#...#.#...#.#.#.............#...###...###.......#...#
#.#.#######.#######.#.###.#.###.#.#.#.#.#####.###.#.###.###.#.#####.#.#####v#.#.###.#.###.#.#.###.#.#.#################.#########.#######.#.#
#.#.#...#...###...#.#.#...#...#.#.#.#.#.#...#...#.#.###.#...#...#...#...#.>.>.#...#.#.....#.#.#...#.#...#...............#.........###.....#.#
#.#.#.#.#.#####.#.#.#.#.#####.#.#.#.#.#.#.#.###.#.#.###.#.#####.#.#####.#.#######.#.#######.#.#.###.###.#.###############.###########.#####.#
#.#...#...#...#.#.#.#.#...#...#.#.#.#.#...#.#...#.#.#...#.#.....#...#...#.#######...#.....#.#.#.....#...#...............#...........#.#...#.#
#.#########.#.#.#.#.#.###.#.###.#.#.#.#####v#.###.#.#.###.#.#######.#.###.###########.###.#.#.#######.#################.###########.#.#.#.#.#
#.#.....#...#.#.#.#.#.#...#.#...#.#.#...#.>.>.###.#.#...#.#.....#...#...#...#.........###...#...#.....#.......#.........###.........#.#.#...#
#.#.###.#.###.#.#.#.#.#.###.#.###.#.###.#.#######.#.###.#.#####.#.#####.###.#.#################.#.#####.#####.#.###########.#########.#.#####
#.#.#...#.#...#.#.#.#...#...#.###.#.###.#.......#.#.#...#.#.....#.....#.....#.......#...###...#.#.#...#...#...#.###...#...#...........#.#...#
#.#.#.###.#.###.#.#.#####.###.###.#.###.#######.#.#.#.###.#.#########.#############.#.#.###.#.#.#.#.#.###.#.###v###.#.#.#.#############v#.#.#
#.#.#...#.#...#.#.#.....#...#.#...#...#.#...#...#.#.#...#.#.#...#...#...#...........#.#...#.#.#.#.#.#...#.#.#.>.>.#.#.#.#.#.....#...#.>.#.#.#
#.#.###.#.###.#.#.#####.###.#.#.#####.#.#.#.#.###.#.###.#.#.#.#.#.#.###.#.###########.###.#.#.#.#.#.###.#.#.#.###.#.#.#.#.#.###.#.#.#.#v#.#.#
#...###...###...#.......###...#.......#...#...###...###...#...#...#.....#.............###...#...#...###...#...###...#...#...###...#...#...#.#
###########################################################################################################################################.#`;

const tiles = raw.split("\n").map((row) => row.split(""));

function createConnectionMap() {
  const connectionMap = [];
  const splittersSet = new Set();
  const splitters = [
    { c: 1, r: 0, name: "1,0" },
    {
      c: tiles.length - 2,
      r: tiles[0].length - 1,
      name: `${tiles.length - 2},${tiles[0].length - 1}`,
    },
  ];
  tiles.forEach((row, r) => {
    row.forEach((tile, c) => {
      if (tile !== "#") {
        let validMoves = 0;
        if (r > 0 && tiles[r - 1][c] !== "#") validMoves++;
        if (r < tiles.length - 1 && tiles[r + 1][c] !== "#") validMoves++;
        if (c > 0 && tiles[r][c - 1] !== "#") validMoves++;
        if (c < tiles[0].length - 1 && tiles[r][c + 1] !== "#") validMoves++;
        if (validMoves > 2) {
          splittersSet.add(`${c},${r}`);
          splitters.push({ c, r, name: `${c},${r}` });
        }
      }
    });
  });

  function getAllDirections(pos) {
    return [
      { r: pos.r, c: pos.c - 1, lastPos: pos },
      { r: pos.r, c: pos.c + 1, lastPos: pos },
      { r: pos.r - 1, c: pos.c, lastPos: pos },
      { r: pos.r + 1, c: pos.c, lastPos: pos },
    ];
  }

  function spawnWalkers(pos) {
    let steps = getAllDirections(pos);
    steps = steps.filter(
      (step) =>
        step.c >= 0 &&
        step.c < tiles[0].length &&
        step.r >= 0 &&
        step.r < tiles.length &&
        tiles[step.r][step.c] !== "#"
    );
    return steps;
  }

  function walk(walker, counter, origin) {
    let steps = getAllDirections({ r: walker.r, c: walker.c });
    steps = steps.filter(
      (step) =>
        step.c >= 0 &&
        step.c < tiles[0].length &&
        step.r >= 0 &&
        step.r < tiles.length &&
        tiles[step.r][step.c] !== "#" &&
        (step.c !== walker.lastPos.c || step.r !== walker.lastPos.r)
    );
    steps = steps.filter((step) => {
      const splitterHit = splittersSet.has(`${step.c},${step.r}`);
      if (splitterHit)
        connectionMap.push({
          from: origin,
          to: `${step.c},${step.r}`,
          steps: counter + 1,
        });
      const borderHit =
        step.c === 0 ||
        step.c === tiles[0].length - 1 ||
        step.r === 0 ||
        step.r === tiles.length - 1;
      if (borderHit)
        connectionMap.push({
          from: origin,
          to: `${step.c},${step.r}`,
          steps: counter + 1,
        });
      return !splitterHit;
    });
    if (steps.length > 1) console.log("ERROR");
    if (steps.length === 0) return;
    walk(steps[0], counter + 1, origin);
  }

  splitters.forEach((splitter) => {
    const walkers = spawnWalkers({ r: splitter.r, c: splitter.c });
    walkers.forEach((walker) =>
      walk(walker, 1, `${walker.lastPos.c},${walker.lastPos.r}`)
    );
  });

  /*
  splitters.forEach(splitter => {
    tiles[splitter.r][splitter.c] = "O";
  });
  console.log(tiles.map(r => r.join("")).join("\n"));
  */

  return connectionMap;
}
const connectionMap = createConnectionMap();
// https://dreampuf.github.io/GraphvizOnline/
// console.log(connectionMap.map(c => `"${c.from}" -> "${c.to}" [label="${c.steps}"]`).join("\n"));

let longestWalked = 0;

function walk(walker) {
  let targets = connectionMap.filter((c) => c.from === walker.pos);
  targets = targets.filter((t) => !walker.hist.includes(t.to));
  const history = [...walker.hist, walker.pos];
  const stepHistory = [...walker.stepHist];
  if (targets.length === 0) {
    if (walker.pos === `${tiles[0].length - 2},${tiles.length - 1}`) {
      const hist = walker.stepHist.reduce((acc, s) => acc + s, 0);
      const totalSteps = hist;
      if (longestWalked < totalSteps) {
        longestWalked = totalSteps;
      }
    }
    return;
  }
  targets.forEach((target, i) => {
    if (i === 0) {
      walker.hist = history;
      walker.pos = target.to;
      walker.stepHist = [...stepHistory, target.steps];
      walk(walker);
    } else {
      const newWalker = {
        hist: history,
        pos: target.to,
        stepHist: [...stepHistory, target.steps],
      };
      walk(newWalker);
    }
  });
}
walk({ name: "1,0", pos: "1,0", hist: [], stepHist: [] });

console.log(longestWalked);
// 6718

/*
1,0
3,5
5,13
13,19
13,13
11,3
21,11
19,19
21,22

steps
0
15
37
75
85
109
139
149
154
*/
