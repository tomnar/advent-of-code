const test = `...........
.....###.#.
.###.##..#.
..#.#...#..
....#.#....
.##..S####.
.##..#...#.
.......##..
.##.#.####.
.##..##.##.
...........`;

const raw = `...................................................................................................................................
................#..#.....#...#........................#...............#................#..........#.......#.....#......#.....#.....
..#..........#...#......#..#.........##.....#....#.....................................#.......#.#........#...#...#.....#..........
....#......##.......#..................#...#......#.............................#..#....#..........#...............................
..................................#...........#...##......................#.#.......##....................#.................#......
..##.#..#.........#.............#.#.....#..................................#................#.......................#..#........#..
...........#.#....#.....#...#..................................#............#......#..#.........#..#....#.......................#..
........#..............#.....#......#...#...........................#...................#.#....#..#........#...#...................
...#......#.....##.............................#.#.......................................................#....#..#..#..............
..#..#...#.....#..#....................#.#...#................#.......................#........#.......#..#........................
...#.#.........#...............#.#.....#.........##..........###.....#.........#.........................#......#..#...#...........
.................#.......##...#........#..................#......................#........#..#.......#............#.#....#.........
.....##........#.............#...#.............................#........##......................#....#..................#.....#....
...................#...#...#......#.#.#...................#.....#.........#..........................#..........#..#.#......#..#.#.
...#.##..#..............................#............................#.................#.......#...#.......#........#...........#..
...#................#....#........................................#.....#............................#..#....#....#.........#......
....#.#.....#............#....#...#.........................#.#...#....#.....#...................#.....##....#.......#...........#.
.#..................##..#.#...............#...............#.#..#...#..#...#.#...........#.#................................#...###.
...............#..........#.....#..#.....#.........##..........##.....#.......##..........#...#..............................#.....
.#..#..##.#.........................##.....................#.................##...............#.#......#.......#......#............
.........##..#.#...............##....................#...#............#.....................##......##....#..........#........#....
.............#...#....#.#..........#.....................#...##.....#.........#...........#.#.............#.#.............##.......
.#.#....#....................#..#.......................#....##.........#......#.........................................#.........
.........#......#..##..#..............................#.......#.....#..............#.................#......#..##...........#......
.#...#..........#..........#....##..................................#.#.......#.................#.#.........#.........#......#.....
..........#....#.....#...................................#............#.....#.........#..................#......#..#....#.....#....
.........#.....................##...........#.#.........#.#......................#.....#........#...#...........##.................
..#....#.........#.............#...........#............#.#....##..........#...#.#..........................#.#....................
....#...........#......###....................#....#.....#..#.....#..#.....#......................##...#.....#..#.....#....#.......
...........#....#...#...#.........................#.......#..#...........#.....#..#.................#..........................#...
........#.......#.#.#..#...............#.#.............................#...#..............#...........##..............#.#..........
..................................................#...........#.....#............#.....................#.....#....###..........#...
.#.#.......#.....#...................#...................#.#..................#....#..........................#....................
..........#....#......#...................#...#............................................................#............#.#..#.#...
..................#..#.....#..........#.#.........................#.....................#.............................#...#........
.........#................#............###.....................#.....#...........#...#....#...............#.........#...........#..
.....#.#.............#..............#....##.....###..##........#..............#............#.......................................
..............#...#..#..........#....#........#........#.......#...............#........#...#.#...#.........#......#......#..#.....
........#........#...............#...#..#...#......##..........#..................#...............#.........#.....#.......#....##..
.........#...##................#.........#...#...........#.....#...#......#....#.#............................#....................
...................................#.............#.......................................#..........##.........#...#.##...#....#...
.............#.............................##.............#.................................##...#....#.................#.....#.#..
.........#......#..............#......#........#..........#..##......#.................#.......................#.......#..#....#...
.....#.#......#...........#...........#....................#.#.....#................#.........#......#.............................
...............#........................................#....#.....#.....#.........#..........#...#....#...........................
.#.............................####.........##.#.#....#.#.......#...##....#............#.#...#.....................#..#............
......#..........................#.....#............................#.#....##......#........#...........#..........................
.......#.#..#.#.........#................#........#.....#.......#....#.......#.#......................###................#.........
.#........##..........#......#......#.......#...#...#.......#.....#................#.......#..#......#.......#.................#...
..............................................#...#.......................#.....#..............##..#..#.....#......................
...................#......#....................#.........#....#....#..#.#.........##....#........#.................................
.....................#..#..........##..............#.....#.#........#................#......................................#......
..#...............#...........#................#.......#...............#..#...#.....#.............#..##....#...............#..#....
...#.#..#........#.#...........##.............#...#......##..#.....#......#.....#..#.......#.......#...#.##...##..........#........
..#..................##....................#.......................................#.....#......#.....###.....#.............#......
..#............#...........#.......#.#................##.....#.##...............#.#..#.................#..#........#...............
..............#..................#........#.........#.......#................#........#........#.....#.#...........#...............
..................#............#.....#...#.#...#...#......#.....#.....#....#..........#........................................#...
.#.........#........#........#.............#...#..#...#...................#......#.................#...#.#.........................
..............#..........##..#....#.....#.......#....#..#..............#..#..............#.................#....#..................
..........#...#...##........#......#.......###...##..........#...........................#...............#.##.........#............
................##..#.............#......#...##......#.....#..............................#.......##.........#..#....#...##........
.................#.......#.......#..#...##...#.......#.....#............#.................##........#.......#.##..........#........
........#....................##.......#.....#..............#.............#.......#...#...........###.............#..#......#.......
..............##............#.#..........##..............#.....#.....#..##.............##..............#.#.........................
.................................................................S.................................................................
..........#.........#.......##...#.#.......#.#.......#...#........##........##...............#..#..#.#..#............##.##.........
........#...............##.........#.........#.#........#.#.#............##....#.......#...#.##...#...#...#........#.....##........
..........#.........................#...#....#.............##..........#..............#.##.........#............#..................
...........#.#................##..........................#..#...............###..#.............#...#..#.........##................
...................................##.............#....#..#.#......#...##.....#..........#.#..........#...........#..............#.
........................#......##.....................#..#...........#............#.........#...................#....#.#...........
...............#....................................#....................................#......#...............#......#...........
..#.............................###...........#........#..#....#....#..#....#..........#....#...#..................................
.................#........................#.......#.#..#.....................#..........##..#....#.#........#.#....................
.....................#...............................................#..#.........#..#.......#.................#...................
.......#........#..#.............#..#......###...#....#................#.....##....#.#..............#.............#.........#.#..#.
.#...#...........#.#..#....#.....#....##..............#...#...........#.....................#.....#..........#.....................
.........#............#.....#.........#.....#...#..#..#.....................#..#..............##..............#....................
.#..#..#....................#..##...#.........#............................#........#.....#.............#.#.............#.#...#....
..#.#.....##..........#.##............#......#..#..............#....#..............#......#..#..#.......#...............#..........
.....................#..........#...##.............#.............................#.....#.....#............#.#..............#.......
..........##............#............#..#..#.........#.#............#..#.................#.......#.....#......................#....
.....#..................#.....#........##.................#.....#....#...#................#....#......#.....#............#....#....
.....#..#.....#..........#...#..#....#....#........#..#..#.....#....#..#..........#............#...##.#...#..............#.......#.
....#...#......#..........#.......#....#........#..#..#.......#.#.................##...#...#.#.#.........#......................#..
..................................#.....#..##...#............#..#..#..........#....#...............#.....................#..#...#..
..#.......#...#.................#...#..............##..................#............#......#........................#........#.....
..#.......#.................#.......#................#..#.#.#......#..................#........#...#........................#..##..
...........#.............................#....###..................#......#.....#.........#...#................#.......#...#.#.....
....#...#.......#................##....#.#..#..#...#..................##....#.................#................##............##....
....................#...............##............##..........#.......#........#........#.......................##..........#......
...#.....#.......#.................#........#.....................#..##........#......................................#......#..#..
.#.....................................##.................#.#.....#......##.#..##................................#...........#.....
................#........#............#...................#........##...................................................#.##.......
.........................#.............#.#..##..#......#.#........#...............#....##...................#.....#................
.....#...#........#.#....................#.#...#..#...#......#......#...................###................#.....#.#...#.......#...
.....#.....................#............#....#.#..#.##...............##.........#........................#.........#....#..........
............#..............#.#.......#...........#....................#......................#.......................#...#.........
..#....###.....##............##................###.#....................#.....#....#..................#..##..#.#...#.........#.....
......##.......#.................................#..#..#.....#..#.#.#.#....#..##.....#.....#.......................#.....#.#..###..
.#.......................#...................#.##..............#...............#..................#.#........#...........#..#......
........#........#..........................#...#..##.................#..#..#.##.......#..............#.#.........#....##..........
.....#...#............##..#......##..............##.###....................#............#.......#............................#.....
........#.#.........##...#.#.....#............#.............#............#......#...............#.#..........................#..##.
...#..#.#...............#....#..##..............#............#.........##...........#.........#...........#...#....#...........#...
.##.......#..##......................................##................#.....#.....................................................
...##.......#......#...#............................................#...#.........................#.#.......#.#.......#....##..#...
..#........#...#.#.#.#.............#...#...............#...............#...................#....#....#...#.#.....#............#....
........................#........#......#.........#......#..........................................#....#.......#..........#......
........#...........#....#..........#.................#......#..#...#.......#...#.....................................#........#...
...#.#..#.#.#....##...#........#......................#....##......#......#...................................#...#.........#......
..#.............#.......#..............#................#....#........#.....##................#.#....#...#.#....#......#..#........
........#...................#...#...........................#.........................#.....#........#......................#.#..#.
.............#....##.....#.#........#......................#..#....#.....#...............#.....#......#.....#....#..#..........#...
..#....#.....#.#.#...........#.#..........#.................#..#...#..................#..........................#.#.....#..#......
...#.....................#.......#...#...#............................##...................#.....#...#.................#...........
..#.....#.............#......##..............##...................#......#.........................##.......#..........#...........
...#................#....#.##.........................................###...........#.#.....#..#...............#...##..............
.......#............#........#...............##..#........................................#.#...........#.....#...#..#.......#.....
......#...................#...##.............................#....#....#........#........#....#........##..........#.........#...#.
..#.#.#......##..#.#.##...........#.#........#....................#.............................................##...#.#.##........
......#.................##..#.#......#.............##..................................#.............#....##..........#............
.......#.#...#...........#.........................#...........#................#............##....#.........#.................#...
....#....##.........#.........#..........##.....##..............#.......................#.....#.#.#.......#...#...#.............#..
...#....#....#.............#...............#....#....###...................#........#.............#.....#..#.........#.....#....#..
....#..............................#..#..........#.................................#.#.................................#..#.....#..
.......###...........................#.................#.#.........................................#.....#...#.........##..........
...........#....#..........#..#..............##..........#...................#.#............#.......#.#..#.#....#.........#......#.
.....#..........###..#.....#.#.........#.............####..#.............#..#.......#.............#...#..........#......#.#........
...................................................................................................................................`;

const initialSteps = 26501365;
const cycle = 64;
const mapWidth = raw.split("\n")[0].length;

// Make map bigger to ensure that we don't have to deal with edge cases
function multiplyMap(map) {
  let lines = map.split("\n");
  res = [];
  for (let i = 0; i < 5; i++) {
    for (let line of lines) {
      res.push(line.replace("S", ".").repeat(5));
    }
  }
  return res.map((line) => line.split(""));
}

// Get the 3 numbers that are used to calculate the number of walkers
function generateSequence(start, step, length) {
  let result = [start];
  for (let i = 1; i < length; i++) {
    result.push(result[i - 1] + step);
  }
  return result;
}
const sequence = generateSequence(cycle + 1, mapWidth, 3);

function countWalkers(input, steps) {
  let walkers = [];
  let walkersNext = [];
  walkers.push([Math.floor(input[0].length / 2), Math.floor(input.length / 2)]);

  function checkTile(tile) {
    const [r, c] = tile;
    const cell = input[r][c];
    if (cell) {
      if (cell === "." || cell === "S") {
        input[r][c] = "X";
        walkersNext.push([r, c]);
      }
    }
  }

  function walk(walker, direction) {
    const [r, c] = walker;
    input[r][c] = ".";
    switch (direction) {
      case "up":
        checkTile([r - 1, c]);
      case "down":
        checkTile([r + 1, c]);
      case "left":
        checkTile([r, c - 1]);
      case "right":
        checkTile([r, c + 1]);
    }
  }

  function walkAll() {
    walkers.forEach((walker) => {
      walk(walker, "up");
      walk(walker, "down");
      walk(walker, "left");
      walk(walker, "right");
    });
    walkers = walkersNext;
    walkersNext = [];
  }

  for (let i = 0; i < steps; i++) {
    walkAll();
  }

  return input.flat().filter((cell) => cell === "X").length;
}

const walkerNumbers = sequence.map((seq) =>
  countWalkers(multiplyMap(raw), seq)
);

function calculateDifferences(row) {
  let result = [];
  for (let i = 1; i < row.length; i++) {
    result.push(row[i] - row[i - 1]);
  }
  return result;
}

function getDifferenceSquence(input) {
  let result = [];
  for (let step of input) {
    result.push(step);
    let differences = step;
    while (true) {
      differences = calculateDifferences(differences);
      if (differences.every((v) => v === 0)) {
        break;
      }
      result.push(differences);
    }
  }
  return result.map((v) => v[0]);
}

const polynomCoeficients = getDifferenceSquence([walkerNumbers]);
const steps = (initialSteps - (cycle + 1)) / mapWidth; // 202300

const result =
  polynomCoeficients[0] +
  polynomCoeficients[1] * steps +
  (steps * (steps - 1) * polynomCoeficients[2]) / 2;

console.log(result);
// 627960775905777
